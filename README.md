# Distributed Task Management System

A distributed task management and execution system based on Flask and SQLite, supporting web interface management, multi-machine distributed execution, and real-time monitoring.

## ‚ú® Features

- üåê **Web Interface Management** - Intuitive task and machine management interface
- üìã **Task Scheduling** - Support for scheduled tasks, instant tasks, and recurring tasks
- üñ•Ô∏è **Distributed Execution** - Multi-machine parallel task execution
- üíæ **Data Persistence** - SQLite database storage, no additional configuration required
- üîÑ **Real-time Monitoring** - WebSocket real-time status updates and log viewing
- üì° **API Interface** - Complete RESTful API support
- ü§ñ **Client Process** - Automatic registration, heartbeat, and task execution
- üè∑Ô∏è **Tag Management** - Support for task and machine tag classification
- üìä **Statistics Dashboard** - System runtime status and performance monitoring

## üõ†Ô∏è Technology Stack

- **Backend Framework**: Flask, Flask-SocketIO, SQLAlchemy
- **Task Scheduling**: APScheduler
- **Frontend Technology**: HTML5, Bootstrap 5, JavaScript ES6
- **Database**: SQLite 3
- **Communication Protocol**: HTTP/HTTPS, WebSocket
- **Runtime Environment**: Python 3.7+

## üìÅ Project Structure

```
task/
‚îú‚îÄ‚îÄ common/                 # Common modules
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py          # Data model definitions
‚îÇ   ‚îú‚îÄ‚îÄ config.py          # Configuration management
‚îÇ   ‚îú‚îÄ‚îÄ server.txt         # Server IP and port configuration (format: IP:PORT)
‚îÇ   ‚îú‚îÄ‚îÄ predefined_commands.py # Built-in system commands
‚îÇ   ‚îú‚îÄ‚îÄ system_info.py     # System information collection
‚îÇ   ‚îî‚îÄ‚îÄ utils.py           # Utility functions
‚îú‚îÄ‚îÄ server/                # Web server
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ app.py             # Flask main application
‚îÇ   ‚îú‚îÄ‚îÄ api.py             # REST API interface
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py       # Task scheduler
‚îÇ   ‚îú‚îÄ‚îÄ database.py        # Database operations
‚îÇ   ‚îú‚îÄ‚îÄ templates/         # HTML templates
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.html     # Home page
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks.html     # Task management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ machines.html  # Machine management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitor.html   # System monitoring
‚îÇ   ‚îî‚îÄ‚îÄ static/            # Static resources
‚îÇ       ‚îú‚îÄ‚îÄ css/style.css  # Style files
‚îÇ       ‚îî‚îÄ‚îÄ js/            # JavaScript files
‚îú‚îÄ‚îÄ client/                # Client process
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ client.py          # Main client process
‚îÇ   ‚îú‚îÄ‚îÄ service.py         # Windows service implementation
‚îÇ   ‚îú‚îÄ‚îÄ executor.py        # Task executor
‚îÇ   ‚îú‚îÄ‚îÄ heartbeat.py       # Heartbeat monitoring
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt   # Client dependencies
‚îú‚îÄ‚îÄ server/                # Server components
‚îÇ   ‚îú‚îÄ‚îÄ task_server.py     # Main server
‚îÇ   ‚îú‚îÄ‚îÄ api_routes.py      # REST API routes
‚îÇ   ‚îú‚îÄ‚îÄ websocket_handler.py # WebSocket handling
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt   # Server dependencies
‚îú‚îÄ‚îÄ examples/              # Example code
‚îú‚îÄ‚îÄ demo.py                # Complete demo script
‚îú‚îÄ‚îÄ test_api.py            # API test script
‚îú‚îÄ‚îÄ test_client.py         # Client process test
‚îú‚îÄ‚îÄ .env.example           # Configuration template
‚îú‚îÄ‚îÄ start.sh              # Linux startup script
‚îú‚îÄ‚îÄ start.bat             # Windows startup script
‚îú‚îÄ‚îÄ service_manager.bat   # Windows service management
‚îú‚îÄ‚îÄ QUICKSTART.md         # Quick start guide
‚îú‚îÄ‚îÄ WINDOWS_SERVICE_GUIDE.md  # Windows service documentation
‚îî‚îÄ‚îÄ README.md             # Project documentation
```

## üöÄ Quick Start

### Method 1: One-click Demo (Recommended for beginners)
```bash
# Install server dependencies
pip install -r server/requirements.txt

# Run complete demo
python demo.py
```

### Method 2: Manual Component Startup

#### 1. Install Dependencies
```bash
# For server components
pip install -r server/requirements.txt

# For client components (if running client separately)
pip install -r client/requirements.txt
```

#### 2. Start Web Server
```bash
# Method 1: Direct run
python -m server.app

# Method 2: Using scripts
# Windows:
start.bat
# Linux/Mac:
./start.sh
```

#### 3. Start Client Process (on target execution machines)
```bash
python -m client.client
# or
python test_client.py
```

#### 4. Access Web Interface
Open browser and visit: http://localhost:5000

## üåê Web Interface Features

### Main Pages
- **Home** (`/`) - System overview and quick operations
- **Task Management** (`/tasks`) - Create, edit, and monitor tasks
- **Machine Management** (`/machines`) - View machine status and management
- **System Monitoring** (`/monitor`) - Real-time monitoring and performance metrics

### Core Functions
1. **Task Management**
   - üìù Create scheduled and instant tasks
   - üéØ Specify target execution machines
   - ‚è∞ Set execution time and retry strategies
   - üìä Real-time view of execution status and logs

2. **Machine Management**
   - üñ•Ô∏è Automatic discovery and registration of machines
   - üíó Real-time heartbeat monitoring
   - üìà Machine performance and status display
   - üè∑Ô∏è Machine tag classification management

3. **Monitoring Dashboard**
   - üìä System runtime statistics
   - üîÑ Real-time status updates
   - üìà Performance metric charts
   - üìã Operation log recording

## üì° API Documentation

### Basic Interfaces
- `GET /api/health` - Health check
- `GET /api/dashboard` - System overview data

### Task Management
- `GET /api/tasks` - Get task list
- `POST /api/tasks` - Create new task
- `GET /api/tasks/{id}` - Get task details
- `PUT /api/tasks/{id}` - Update task information
- `DELETE /api/tasks/{id}` - Delete task

### Machine Management
- `GET /api/machines` - Get machine list
- `POST /api/machines/register` - Register new machine
- `PUT /api/machines/{id}/heartbeat` - Update machine heartbeat

### WebSocket Events
- `task_status_changed` - Task status change
- `machine_status_changed` - Machine status change
- `task_log` - Task execution log

## üîß Configuration

Copy `.env.example` to `.env` and modify configuration:

```env
# Server configuration
SERVER_HOST=0.0.0.0          # Server listening address
SERVER_PORT=5000             # Server port
DEBUG=True                   # Debug mode

# Database configuration
DATABASE_URL=sqlite:///tasks.db  # SQLite database file

# Time interval configuration (seconds)
HEARTBEAT_INTERVAL=30        # Heartbeat interval
TASK_POLL_INTERVAL=10        # Task polling interval
TASK_TIMEOUT=300             # Task execution timeout

# Log configuration
LOG_LEVEL=INFO               # Log level
```

## ü§ñ Client Deployment

### **Windows Service Deployment (Recommended for Production)**

The client can be installed as a Windows service for automatic startup and management:

#### **Quick Service Installation**
```batch
# Install as Windows service with automatic server configuration
service_manager.bat install

# Start the service
service_manager.bat start

# Check service status
service_manager.bat status
```

#### **Automatic Server Configuration**
The service automatically reads server address from `common/server.txt` file:

1. **Create server configuration file**:
   ```batch
   # Using IP address with port
   echo 192.168.1.100:5000 > common\server.txt
   
   # Using IP address only (default port 5000)
   echo 192.168.1.100 > common\server.txt
   
   # Using full URL (if needed)
   echo http://192.168.1.100:8080 > common\server.txt
   ```

2. **Service reads configuration automatically**:
   - Primary: `common/server.txt` (supports IP:PORT, IP only, or full URLs)
   - Format: IP:PORT (e.g., 192.168.1.100:5000)
   - Fallback: Default localhost (127.0.0.1:5000)
   - Configuration updates every 10 minutes

3. **No manual server URL input required**

#### **Service Management Commands**
```batch
# Service control
service_manager.bat start    # Start service
service_manager.bat stop     # Stop service  
service_manager.bat restart  # Restart service
service_manager.bat status   # Show status
service_manager.bat uninstall # Remove service
```

#### **Service Features**
- ‚úÖ **Automatic Registration**: Registers with server on service start
- ‚úÖ **Automatic Unregistration**: Unregisters from server on service stop
- ‚úÖ **Automatic Server Configuration**: Reads server address from `common/server.txt` file
- ‚úÖ **Windows Integration**: Runs as native Windows service
- ‚úÖ **System Information**: Automatically collects and reports CPU, Memory, GPU, OS details
- ‚úÖ **Persistent Configuration**: Stored in `C:/WebGraphicsTasks/config.json`
- ‚úÖ **Comprehensive Logging**: Service logs in `C:/WebGraphicsTasks/logs/`
- ‚úÖ **Periodic Updates**: Configuration refreshed every 10 minutes
- ‚úÖ **Administrator Tools**: Easy install/uninstall/management

### **Server Configuration Options**

The `common/server.txt` file supports multiple formats for IP and port configuration:

**üìç IP:PORT Format (Recommended):**
```
192.168.1.100:5000
```
*Used exactly as: `http://192.168.1.100:5000`*

**üìç IP Address Only:**
```
192.168.1.100
```
*Automatically becomes: `http://192.168.1.100:5000`*

**üîó Full URL Format (Optional):**
```
http://192.168.1.100:8080
https://secure-server.com:443
```
*Used exactly as specified*

**üîÑ Dynamic Updates:**
- Configuration is reloaded every 10 minutes automatically
- No service restart required when server address changes
- Supports seamless server migration

For detailed service documentation, see [WINDOWS_SERVICE_GUIDE.md](WINDOWS_SERVICE_GUIDE.md)

### **Manual Deployment (Development/Testing)**

Deployment steps on target machines:

1. **Copy project files**
```bash
scp -r task/ user@target-machine:/opt/task-client/
```

2. **Install dependencies**
```bash
pip install -r client/requirements.txt
```

3. **Configure server address**
Modify `SERVER_URL` in `.env` file

4. **Start client process**
```bash
python -m client.client --server-url http://server:5000 --machine-name client-machine
```

### Auto-start on boot

#### **Windows Service (Recommended)**
```batch
# Install as Windows service (runs automatically on startup)
service_manager.bat install --server-url http://your-server:5000
service_manager.bat start

# Service will automatically start on system boot
# No additional configuration needed
```

#### **Windows Task Scheduler (Alternative)**
```batch
# Using task scheduler for non-service deployment
schtasks /create /tn "TaskClient" /tr "python C:\path\to\client\client.py --server-url http://server:5000 --machine-name client" /sc onstart
```

#### **Linux System**
```bash
# Create systemd service
sudo tee /etc/systemd/system/task-client.service > /dev/null <<EOF
[Unit]
Description=Distributed Task Management Client
After=network.target

[Service]
Type=simple
User=taskuser
WorkingDirectory=/opt/task-client
ExecStart=/usr/bin/python3 -m client.client --server-url http://server:5000 --machine-name client
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
sudo systemctl enable task-client
sudo systemctl start task-client
```

## üìã Usage Examples

### Create Task via API
```python
import requests
from datetime import datetime, timedelta

# Create task data
task_data = {
    "name": "System Backup Task",
    "command": "tar -czf /backup/system-$(date +%Y%m%d).tar.gz /etc /home",
    "target_machines": ["server-001", "server-002"],
    "scheduled_time": (datetime.now() + timedelta(hours=1)).isoformat(),
    "timeout": 3600,
    "retry_count": 2,
    "tags": ["backup", "daily"]
}

# Submit task
response = requests.post("http://localhost:5000/api/tasks", json=task_data)
if response.status_code == 201:
    task = response.json()
    print(f"Task created successfully, ID: {task['id']}")
```

### Query Task Status
```python
import requests

# Get task list
response = requests.get("http://localhost:5000/api/tasks")
tasks = response.json()

for task in tasks:
    print(f"Task: {task['name']} - Status: {task['status']}")
```

## üß™ Testing and Validation

### Run Test Scripts
```bash
# API functionality test
python test_api.py

# Client functionality test
python test_client.py

# Complete system demo
python demo.py
```

### Validate System Functions
1. ‚úÖ Web interface access normal
2. ‚úÖ Client process successfully registered
3. ‚úÖ Tasks created and executed normally
4. ‚úÖ Real-time status updates
5. ‚úÖ Logs recorded correctly

## üîç Troubleshooting

### Common Issues and Solutions

**Q: SSL error - 'module ssl has no attribute wrap_socket'**
```bash
# This issue occurs with Python 3.13+ and older Flask-SocketIO versions
# Solution: Update to compatible versions (already fixed in this project)
pip install flask==3.0.3 flask-socketio==5.4.1
# Or reinstall all dependencies: pip install -r server/requirements.txt
```

**Q: Port 5000 is in use**
```bash
# Find occupying process
netstat -ano | findstr :5000
# Kill process or modify port in configuration file
```

**Q: Client process cannot connect to server**
- Check network connection and firewall settings
- Confirm server address and port configuration
- Check if server is running normally

**Q: Task execution failed**
- Check if command syntax is correct
- Confirm target machine is online
- View task execution logs for detailed errors

**Q: Database operation failed**
- Check database file permissions
- Ensure SQLite file directory is writable
- Reinitialize database

## üìà Performance Optimization

### System Tuning Recommendations
1. **Database Optimization**
   - Regularly clean historical logs
   - Add indexes for common queries
   - Consider using PostgreSQL to replace SQLite

2. **Network Optimization**
   - Adjust heartbeat interval to balance real-time and performance
   - Use connection pools to reduce connection overhead
   - Enable compression to reduce data transmission

3. **Concurrent Processing**
   - Increase number of worker processes
   - Use asynchronous task queues
   - Implement load balancing

## üõ°Ô∏è Security Recommendations

1. **Authentication and Authorization**
   - Implement user login and access control
   - Use JWT or Session to manage user state
   - Limit API access permissions

2. **Network Security**
   - Use HTTPS for encrypted communication
   - Configure firewall to restrict access
   - Validate all user inputs

3. **Data Security**
   - Regularly backup database
   - Encrypt sensitive information storage
   - Record detailed operation audit logs

## üéØ Extension Development

### Feature Extension Directions
1. **Task Type Extensions**
   - Support script file upload and execution
   - Integrate Docker container tasks
   - Add data synchronization tasks

2. **Monitoring Enhancements**
   - Integrate Prometheus metrics
   - Add email/SMS alerts
   - Implement performance analysis dashboard

3. **Cluster Deployment**
   - Support multi-server clusters
   - Implement load balancing
   - Add failover mechanisms

### Secondary Development Guide
For detailed development documentation and API reference, please see the `QUICKSTART.md` file.

## üìÑ License

This project is licensed under the MIT License, see LICENSE file for details.

## ü§ù Contributing

Welcome to submit Issues and Pull Requests to improve the project!

1. Fork the project
2. Create feature branch
3. Submit changes
4. Create Pull Request

## üìû Technical Support

If you encounter problems, please:
1. Check the quick start guide `QUICKSTART.md`
2. Run test scripts to verify functionality
3. Check console logs for error information
4. Submit Issue with detailed problem description
